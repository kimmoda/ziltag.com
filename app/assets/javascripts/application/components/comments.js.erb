// 留言功能

$(window).on('load page:load', function(){

  if( $("[data-comments]").length > 0 ){

    // 新增留言的 obj
    var post_comment = {
      "comment": {
        "text": "",
        "comment_id": "",
        "x": "",
        "y": "",
        "email": "",
        "user_id": "",
        "photo_id": "",
      }
    };

    var comment_zone = $("[data-comments]");
    var comment_zone_img = $(comment_zone).find("img")[0];
    var photo_id = $(comment_zone_img).data("photo-id");
    var ratio = {};
    ratio.x = $(comment_zone_img)[0].clientWidth / $(comment_zone_img)[0].naturalWidth;
    ratio.y = $(comment_zone_img)[0].clientHeight / $(comment_zone_img)[0].naturalHeight;

    // 取得所有該 photo 的留言
    $.ajax({
      url: '/comments.json?photo_id=' + photo_id,
      type: 'GET',
      data: "",
      dataType: 'json',
      success: function(data){
        $.each(data, function(index, obj){
          console.log(obj);

            if( obj.user == null ){
              var user_id = "";
              var user_email = "";
              var user_name = "#";
              var avatar_thumb_url = "/images/fallback/thumb_guest.png";

            }else{
              var user_id = obj.user.id;
              var user_email = obj.user.email;
              var user_name = "/users/" + obj.user.username;
              var avatar_thumb_url = obj.user.avatar_thumb_url;
            }

            if( user.login_status ){ // 是否有登入
              var current_user_avatar = "";
            }else{
              var current_user_avatar = "/images/fallback/thumb_guest.png";
            }

            var source   = $("#handlebar_comment").html();
            var template = Handlebars.compile(source);
            var context = {
              comment_id: obj.id,
              pos_left: (obj.x * ratio.x),
              pos_top: (obj.y * ratio.y),
              user_id: user_id,
              user_email: user_email,
              user_name: user_name,
              user_avatar: avatar_thumb_url,
              first_msg: obj.text,
              current_user_avatar: current_user_avatar
            };
            var html    = template(context);

            $("article.c_ziltag_sticker_article").prepend(html);
        });

      }
    });




    // 在圖片上點擊，新增留言
    $(comment_zone).on("click", function(e){
      $(".parent_comment").removeClass("z_index_plus");
      var comment_zone_img = $(this).find("img")[0];

      var relX = e.pageX - $(this).parent().offset().left;
      var relY = e.pageY - $(this).parent().offset().top;

      // 未依比例的原來x,y座標
      post_comment.comment.x = relX / ratio.x;
      post_comment.comment.y = relY / ratio.y;
      post_comment.comment.photo_id = $(comment_zone_img).data("photo-id");

      var source   = $("#handlebar_comment_create").html();
      var template = Handlebars.compile(source);
      var context = {
        pos_left: relX,
        pos_top: relY
      };
      var html    = template(context);

      $("article.c_ziltag_sticker_article").append(html);

    });

    // 按下 enter 鍵，送出 "新增留言"
    $(document).on("keyup", "input.leave_msg", function(e){
      if (e.keyCode == 13) {
        $(this).closest(".leave_msg_block").find("button.send_msg").click();
      }
    });
    // 按下發佈按鈕
    $(document).on("click", "button.send_msg", function(){

      var comment_text = $(this).closest("div.leave_msg_block").find("input.leave_msg").val();

      if( comment_text.trim() == "" ){
        $(this).closest("div.leave_msg_block").find("input.leave_msg").css("border", "1px solid red");
        return;
      }else{
        $(this).closest("div.leave_msg_block").find("input.leave_msg").css("border", "1px solid #ccc");
      }

      if( user.login_status ){
        post_comment.comment.user_id = $("li[data-user-id]").data("user-id");
      }else{
        var comment_email = $(this).closest("div.leave_msg_block").find("input.leave_email").val();
        if( comment_email.trim() == "" ){
          $(this).closest("div.leave_msg_block").find("input.leave_email").css("border", "1px solid red");
          return;
        }else{
          $(this).closest("div.leave_msg_block").find("input.leave_email").css("border", "1px solid #ccc");
          post_comment.comment.email = comment_email;
        }
      }

      post_comment.comment.text = comment_text;

      if( $(this).closest(".parent_comment").attr("data-first-message") == "true" ){ // 新增最上層留言

        var that = $(this);
        console.log(post_comment);

        // 已登入：新增留言
        $.ajax({
          url: '/comments.json', // photo_id
          type: 'POST',
          data: post_comment,
          dataType: 'json',
          success: function(data){
            console.log(data);
            $(that).closest(".parent_comment").attr("data-first-message", false);

            $(that).closest(".parent_comment").find("div.all_comments_msg").removeClass("hidden");
            $(that).closest(".parent_comment").find("span.original_text").html(data.text);
            $(that).closest(".parent_comment").find("div.leave_msg_block").addClass("other_comments");
            $(that).closest(".parent_comment").find("span.remove_comment").addClass("hidden");

            $(that).closest(".parent_comment").attr("data-comment-id", data.id);
            $(that).closest(".parent_comment").attr("data-comment-user-id", data.user.id);

          }
        });


      }else{
        $(this).closest(".parent_comment").find("ul.other_user_comments_list").removeClass("hidden");

        var source   = $("#handlebar_comment_children_create").html();
        var template = Handlebars.compile(source);
        var context = {
          current_user_avatar: "", // /images/fallback/thumb_guest.png
          user_name: '<%=' current_user.username '%>',
          user_text: comment_text
        };
        var html    = template(context);

        $(this).closest(".parent_comment").find("ul.other_user_comments_list").append(html);
      }

      if( $(this).closest("div.leave_msg_block").find("input.leave_email").length > 0 ){
        $(this).closest("div.leave_msg_block").find("input.leave_email").val("");
      }
      $(this).closest("div.leave_msg_block").find("input.leave_msg").val("");

    });

    // 移除此留言串
    $(document).on("click", "span.remove_comment", function(){

      if( $(this).closest(".parent_comment").attr("data-comment-id") != "" ){
        var comment_id = $(this).closest(".parent_comment").attr("data-comment-id");
        var that = $(this);
        $.ajax({
          url: '/comments/' + comment_id + '.json',
          type: 'DELETE',
          data: post_comment,
          dataType: 'json',
          success: function(data){
          },
          statusCode: {
      		  200: function(){
      		    $(that).closest(".parent_comment").remove();
      		  }
      		}
        });
      }else{
        $(this).closest(".parent_comment").remove();
      }
    });

    // 最一開始的留言點擊時
    $(document).on("click", "li.original_text", function(){

      if( $(this).attr("data-status") == "close" ){
        $(this).attr("data-status", "open");
        $(this).find("span.original_text").css({
          "text-overflow": "inherit",
          "overflow": "visible",
          "white-space": "normal"
        });
      }else{
        $(this).attr("data-status", "close");
        $(this).find("span.original_text").css({
          "text-overflow": "ellipsis",
          "overflow": "hidden",
          "white-space": "nowrap"
        });
      }

      $(this).find("span.hint_arrow").toggleClass("hidden");
      if( user.id == $(this).closest(".parent_comment").data("comment-user-id") ){
        $(this).closest(".parent_comment").find("span.remove_comment").toggleClass("hidden");
      }
      $(".parent_comment").removeClass("z_index_plus");
      $(this).closest(".parent_comment").addClass("z_index_plus");
      $(this).closest(".parent_comment").find("div.leave_msg_block").slideToggle();
    });

    $(comment_zone).css("border", "1px solid blue");
  }
});
